<!DOCTYPE html>
<html class="no-js">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>nRF Radio 802.15.4 event debugger</title>
        <link rel="Shortcut icon" href="http://www.nordicsemi.com/extension/nordic/design/bootnordic/images/favicon.ico" type="image/x-icon" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    </head>
    <body>

        <div class="container">

            <h3 class="text-center">Sequence diagram generator for <span class="label label-info">nrf_802154</span></h3>

            <div class="form-group">
            <label for="gdb-command">GDB command:</label>
            <p id="gdb-command">set print elements 0<br>set print repeats unlimited<br>set pagination off<br>set height unlimited<br><br>p/z nrf_802154_debug_log_buffer<br>p nrf_802154_debug_log_ptr</p>
            </div>

            <form id="draw-form">
            <div class="form-group">
            <label for="debug-str">GDB Log:</label>
            <p id="gdb-command">Paste below value of <tt>nrf_802154_debug_log_buffer</tt> from GDB output.</p>
            <textarea class="form-control" rows="10" id="debug-str"></textarea>
            </div>

            <div class="form-group">
            <label for="debug-ptr">Index pointer:</label>
            <p id="gdb-command">Paste below result value of <tt>nrf_802154_debug_log_ptr</tt> from GDB output.</p>
            <input type="text" class="form-control" id="debug-ptr">
            </div>

            <div class="form-group">
            <label for="debug-str">Function id to function name map</label>
            <p id="gdb-command">Paste below result of <tt>make_addr2fname_map.sh</tt> script.</p>
            <textarea class="form-control" rows="5" id="debug-func_map"></textarea>
            </div>

            <div class="col-xs-12 text-center">
            <button type="button" class="btn btn-success" id="draw">Generate sequence diagram</button>
            </div>
            </form>

            <br /><br /><br />

            <div id="loading" style="display: none">
                <div class="alert alert-success">Loading SVG..</div>
            </div>
            <div id="errorbox" style="display: none">
                <div id="errorboxText" class="alert alert-danger">Error</div>
            </div>
            <div id="diagram" style="text-align: center">
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg-min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
        <script src="debugLogDecoderData.js"></script>
        <script src="debugLogDecoder.js"></script>

        <script type="text/javascript">
        
        // Loads GDB input nrf_802154_debug_log array
        // Return: array of integers being eventCodes 
        function loadGdbDebugLog(inputStr)
        {
            var str = inputStr.substring(inputStr.indexOf("{"));
            
            str = str.replace('{', '[');
            str = str.replace('}', ']');
            str = str.replace(/0x[0-9a-fA-F]{8}/g, function (x){return parseInt(x)});

            return jQuery.parseJSON(str);
        }
        
        function loadFuncMap(inputStr)
        {
            var arr = inputStr.split(/\r?\n/);
            for (var i = 0; i < arr.length; i++)
            {
                var words = arr[i].split(/ +/);
                var obj = {};
                obj.id = parseInt(words[0]);
                obj.name = words[1];
                arr[i] = obj;
            }                        
            return arr;
        }

        // Loads all input data necessary to draw 
        function loadInput()
        {
            var debug_str = $('#debug-str').val();
            var debug_ptr = $('#debug-ptr').val();
            var debug_funcmap_str = $('#debug-func_map').val();
            
            var result = {};
            
            result.debug_log = loadGdbDebugLog(debug_str);
            result.debug_log_ptr = parseInt(debug_ptr);
            result.funcMap = loadFuncMap(debug_funcmap_str);            
            
            return result;
        }
        
        function makeSequenceDiagramParticipants(modules)
        {
            var result = "" ;
            for (var i = 0; i < modules.length; i++) {
                result += "Participant " + modules[i].name + "\n";
            }
            return result;
        }
        
        function makeSequenceDiagramEvent(event)
        {
            // Hints how to display on sequence diagram (see js-sequence-diagrams lib)
            // - for function enter: "callerModule.name" + " -> " + calledModule.name": " + text
            // - for function exit: "calledModule.name" + " --> " + callerModule.name": " + text
            // - for simple block: "Note over " + module.name + ": " + text
            return "Note over " + event.module.name + ": " + event.text;
        }
        
        function makeSequenceDiagram(input)
        {
            var result = "" ;
            var decoder = new DebugLogDecoder(debugLogDecoderModules, debugLogDecoderGlobalEvents, input.funcMap);
            
            result += makeSequenceDiagramParticipants(decoder.modules);
            
            var index = input.debug_log_ptr;
            for (var i = 0; i < input.debug_log.length; i++)
            {
                var eventCode = input.debug_log[index];
                if (eventCode != 0)
                {
                    var decodedEvent = decoder.parseEventCode(eventCode);
                    result += makeSequenceDiagramEvent(decodedEvent) + "\n";
                }                
                else {
                    // eventCode == 0 means entry that has been not written yet thus we skip it
                }
                index = (index + 1) % input.debug_log.length;
            }
            
            return result;
        }
        
        function draw()
        {
            $('#diagram svg').remove();
            $('#errorbox').hide();
            $('#loading').show();
                
            setTimeout(function(){
                try {        
                    var input = loadInput();
                    var sequenceDiagramCmdStr = makeSequenceDiagram(input);
                    
                    var sequenceDiagram = Diagram.parse(sequenceDiagramCmdStr);
                    sequenceDiagram.drawSVG('diagram', {theme: 'simple'});                    

                    $('#loading').hide();
                }
                catch(err) {
                    $('#loading').hide();
                    $('#errorboxText').text( "Error: " + err );
                    $('#errorbox').show();
                }
            }, 100);

            return false;
        };

        $('#draw').click(draw);
        $('#draw-form').submit(draw);
        </script>
    </body>
</html>
