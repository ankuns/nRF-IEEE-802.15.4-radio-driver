<!DOCTYPE html>
<html class="no-js">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>nRF Radio 802.15.4 event debugger</title>
        <link rel="Shortcut icon" href="http://www.nordicsemi.com/extension/nordic/design/bootnordic/images/favicon.ico" type="image/x-icon" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    </head>
    <body>

        <div class="container">

            <h3 class="text-center">Sequence diagram generator for <span class="label label-info">nrf_802154</span></h3>

            <div class="form-group">
            <label for="gdb-command">GDB command:</label>
            <p id="gdb-command">set print elements 0<br>set print repeats unlimited<br>set pagination off<br>set height unlimited<br><br>p/z nrf_802154_debug_log_buffer<br>p nrf_802154_debug_log_ptr</p>
            </div>

            <form id="draw-form">
            <div class="form-group">
            <label for="debug-str">GDB Log:</label>
            <p id="gdb-command">Paste below value of <tt>nrf_802154_debug_log_buffer</tt> from GDB output.</p>
            <textarea class="form-control" rows="10" id="debug-str"></textarea>
            </div>

            <div class="form-group">
            <label for="debug-ptr">Index pointer:</label>
            <p id="gdb-command">Paste below result value of <tt>nrf_802154_debug_log_ptr</tt> from GDB output.</p>
            <input type="text" class="form-control" id="debug-ptr">
            </div>

            <div class="form-group">
            <label for="debug-str">Function id to function name map</label>
            <p id="gdb-command">Paste below result of <tt>make_addr2fname_map.sh</tt> script.</p>
            <textarea class="form-control" rows="5" id="debug-func_map"></textarea>
            </div>

            <div class="col-xs-12 text-center">
            <button type="button" class="btn btn-success" id="draw">Generate sequence diagram</button>
            </div>
            </form>

            <br /><br /><br />

            <div id="loading" style="display: none">
                <div class="alert alert-success">Loading SVG..</div>
            </div>
            <div id="errorbox" style="display: none">
                <div id="errorboxText" class="alert alert-danger">Error</div>
            </div>
            <div id="diagram" style="text-align: center">
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg-min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>

        <script type="text/javascript">
        /**
         * Simple inline JSON event decoder.
         */

        /************************************************************
         * Events
         ************************************************************/

        var events = [
            {
                id :  "NRF_802154_DEBUG_LOG_EVENT_FUNCTION_ENTRY",
                val:  1,
                draw: function(from, to, text, param)
                {
                    if (from != to)
                    {
                        return from + "->" + to + ": " + text;
                    }
                    else
                    {
                        return "Note over " + from + ": Enter " + text;
                    }

                }
            },
            {
                id :  "NRF_802154_DEBUG_LOG_EVENT_FUNCTION_EXIT",
                val:  2,
                draw: function(from, to, text, param)
                {
                    if (from != to)
                    {
                        return to + "-->" + from + ": " + text;
                    }
                    else
                    {
                        return "Note over " + from + ": Exit " + text;
                    }
                }
            },
            {
                id :  "SET_STATE",
                val:  5,
                draw: function(from, to, text, param)
                {
                    var ret = "Note over DRIVER: ";

                    switch (param)
                    {
                        case 0:
                            ret += "RADIO_STATE_SLEEP";
                        break;
                        case 1:
                            ret += "RADIO_STATE_FALLING_ASLEEP";
                        break;
                        case 2:
                            ret += "RADIO_STATE_RX";
                        break;
                        case 3:
                            ret += "RADIO_STATE_TX_ACK";
                        break;
                        case 4:
                            ret += "RADIO_STATE_CCA_TX";
                        break;
                        case 5:
                            ret += "RADIO_STATE_TX";
                        break;
                        case 6:
                            ret += "RADIO_STATE_RX_ACK";
                        break;
                        case 7:
                            ret += "RADIO_STATE_ED";
                        break;
                        case 8:
                            ret += "RADIO_STATE_CCA";
                        break;
                        case 9:
                            ret += "RADIO_STATE_CONTINUOUS_CARRIER";
                        break;
                        case 10:
                            ret += "RADIO_STATE_MODULATED_CARRIER";
                        break;
                        default:
                            console.log("state = " + param);
                            break;
                    }

                    return ret;
                }
            },
            {
                id :  "RADIO_RESET",
                val:  6,
                draw: function(from, to, text, param)
                {
                    return "Note over DRIVER: Reset";
                }
            },
            {
                id :  "TIMESLOT_REQUEST",
                val:  7,
                draw: function(from, to, text, param)
                {
                    return "Note over RAAL: Timeslot Request (" +  param + "us)";
                }
            },
            {
                id :  "TIMESLOT_REQUEST_RESULT",
                val:  8,
                draw: function(from, to, text, param)
                {
                    return "Note over RAAL: Timeslot Request Result (" +  param + ")";
                }
            },
            {
                id :  "EVENT_TIMESTAMP",
                val:  9,
                draw: function(from, to, text, param)
                {
                    return "Note over RAAL: Timestamp: " +  param + " ms";
                }
            },
            {
                id :  "EVENT_TIMESLOT_STATE",
                val:  10,
                draw: function(from, to, text, param)
                {
                    var ret = "Note over RAAL: ";

                    switch (param)
                    {
                        case 0:
                            ret += "TIMESLOT_STATE_IDLE";
                        break;
                        case 1:
                            ret += "TIMESLOT_STATE_REQUESTED";
                        break;
                        case 2:
                            ret += "TIMESLOT_STATE_GRANTED";
                        break;
                        case 3:
                            ret += "TIMESLOT_STATE_BLOCKED";
                        break;
                        case 4:
                            ret += "TIMESLOT_STATE_MARGIN";
                        break;
                        default:
                            console.log("state = " + param);
                            break;
                    }

                    return ret;
                }
            },
        ];

        var modules = [
            {module_id: 1, module_name: "APPLICATION"},
            {module_id: 2, module_name: "CORE"},
            {module_id: 3, module_name: "RSCH"},
            {module_id: 4, module_name: "CRITICAL_SECTION"},
            {module_id: 5, module_name: "TIMER_COORD"},
            {module_id: 6, module_name: "TRX"},
            {module_id: 7, module_name: "TIMER_SCHED"},
            {module_id: 8, module_name: "CSMACA"},
            {module_id: 9, module_name: "DELAYED_TRX"},
            {module_id: 10, module_name: "ACK_TIMEOUT"},
            {module_id: 11, module_name: "RAAL"}
        ];

        var debugDecoder = function(debug_json, debug_ptr, debug_funcmap)
        {
            this.addr2fname_map = this.parseAddr2fnameMap(debug_funcmap);
            
            // Diagram sequence input syntax.
            this.input = "";

            // Transform GDB input to JSON compatible object.
            debug_json = debug_json.substring(debug_json.indexOf("{"));
            debug_json = debug_json.replace(/0x[0-9a-fA-F]{8}/g, function myFunction(x){return '"' + x + '"'});
            debug_json = debug_json.replace('{', '[');
            debug_json = debug_json.replace('}', ']');

            this.json = jQuery.parseJSON(debug_json);
            this.ptr  = debug_ptr;
        }
        
        debugDecoder.prototype.parseAddr2fnameMap = function(addr2fname_map)
        {
            var arr = addr2fname_map.split(/\r?\n/);
            for (var i = 0; i < arr.length; i++)
            {
                var words = arr[i].split(/ +/);
                var obj = {};
                obj.func_id = parseInt(words[0]);
                obj.text = words[1];
                arr[i] = obj;
            }                        
            return arr;
        }

        debugDecoder.prototype.addLine = function(line)
        {
            this.input += line + "\n";
        }

        debugDecoder.prototype.getFunctionIndex = function(func_id)
        {
            for (var i = 0; i < this.addr2fname_map.length; i++)
            {
                if (this.addr2fname_map[i].func_id == func_id)
                {
                    return i;
                }
            }

            return -1;
        }

        debugDecoder.prototype.getEventIndex = function(val)
        {
            for (var i = 0; i < events.length; i++)
            {
                if (events[i].val == val)
                {
                    return i;
                }
            }

            return -1;
        }
        
        debugDecoder.prototype.getParticipant = function(module_id)
        {
            for (var i = 0; i < modules.length; i++)
            {
                if (modules[i].module_id == module_id) {
                    return modules[i].module_name;
                }
            }
            return "Unknown (" + module_id.toString() + ")";
        }
        
        debugDecoder.prototype.parseEvents = function()
        {
            var last_element = this.ptr ? this.ptr : this.json.length - 1;
            i = parseInt(this.ptr);

            do
            {
                var hexValue = parseInt(this.json[i]);

                if (hexValue == 0)
                {
                    i = (i + 1) % this.json.length;
                    continue;
                }

                var event_id   = (hexValue >> 28) & 0xF;
                var module_id = (hexValue >> 22) & 0x3F;
                var func_id   = (hexValue) & 0x3FFFFF;

                var event_index = this.getEventIndex(event_id);
                var func_index  = this.getFunctionIndex(func_id);

                if (event_index != -1)
                {
                    if (func_index != -1)
                    {
                        this.addLine(events[event_index].draw(
                            this.getParticipant(module_id),
                            this.getParticipant(module_id),
                            this.addr2fname_map[func_index].text,
                            func_id
                        ));
                    }
                    else
                    {
                        this.addLine(events[event_index].draw(0, 0, "???", func_id));
                    }
                }
                else
                {
                    console.log('Cannot parse - ' + this.json[i]);
                }

                if (++i == this.json.length)
                {
                    i = 0;
                }
             } while (i != last_element)
        }
                
        
        debugDecoder.prototype.createParticipants = function()
        {
            for (var i = 0; i < modules.length; i++) {
                this.addLine("Participant " + modules[i].module_name);
            }
        }

        debugDecoder.prototype.draw = function()
        {            
            this.createParticipants();
            this.parseEvents();

            var d = Diagram.parse(this.input);
            d.drawSVG('diagram', {theme: 'simple'});
        }

        function draw()
        {
            try {        
                $('#diagram svg').remove();
                $('#errorbox').hide();
                $('#loading').show();
                
                setTimeout(function(){
                    var debug_str = $('#debug-str').val();
                    var debug_ptr = $('#debug-ptr').val();
                    var debug_funcmap = $('#debug-func_map').val();

                    var decoder = new debugDecoder(debug_str, debug_ptr, debug_funcmap);
                    decoder.draw();

                    $('#loading').hide();
                }, 100);
            }
            catch(err) {
                $('#loading').hide();
                $('#errorboxText').text( "Error: " + err );
                $('#errorbox').show();
            }

            return false;
        };

        $('#draw').click(draw);
        $('#draw-form').submit(draw);
        </script>
    </body>
</html>
